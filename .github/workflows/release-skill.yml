name: Release Blueprint Skill

on:
  push:
    branches:
      - main
    paths:
      - 'packages/blueprint-skill/**'
      - '.github/workflows/release-skill.yml'

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Release Blueprint Skill
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/blueprint-skill
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@bertrindade'

      - name: Install dependencies
        run: npm ci || echo "No dependencies to install"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Release
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if semantic-release is available
          if [ -f "package.json" ] && grep -q "semantic-release" package.json; then
            OLD_VERSION=$(node -p "require('./package.json').version")
            npx semantic-release || true
            NEW_VERSION=$(node -p "require('./package.json').version")
            
            if [ "$OLD_VERSION" != "$NEW_VERSION" ]; then
              echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
              echo "published=true" >> $GITHUB_OUTPUT
            else
              echo "published=false" >> $GITHUB_OUTPUT
            fi
          else
            # Manual version bump for first release
            # This is a simple package, so we'll use a basic versioning approach
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "published=true" >> $GITHUB_OUTPUT
          fi

      - name: Publish to GitHub Packages
        if: steps.release.outputs.published == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm publish
