# .github/workflows/deploy.yml
# Multi-environment deployment workflow with approval gates
# Supports: dev → staging → prod promotion

name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Terraform action'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: plan

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-west-2
  TF_VERSION: '1.9.0'

jobs:
  # ============================================
  # VALIDATE: Ensure environment exists
  # ============================================
  validate:
    name: Validate
    runs-on: ubuntu-latest
    outputs:
      env_path: ${{ steps.check.outputs.env_path }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check environment exists
        id: check
        run: |
          ENV_PATH="environments/${{ inputs.environment }}"
          if [ ! -d "$ENV_PATH" ]; then
            echo "❌ Environment not found: $ENV_PATH"
            echo ""
            echo "Available environments:"
            ls -la environments/ || echo "No environments found"
            echo ""
            echo "To create this environment, run:"
            echo "  ./scripts/create-environment.sh ${{ inputs.environment }}"
            exit 1
          fi
          echo "✅ Environment found: $ENV_PATH"
          echo "env_path=$ENV_PATH" >> $GITHUB_OUTPUT

  # ============================================
  # DEV: Deploy to dev (no approval)
  # ============================================
  deploy-dev:
    name: Deploy to Dev
    needs: validate
    if: inputs.environment == 'dev'
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ needs.validate.outputs.env_path }}

      - name: Terraform ${{ inputs.action }}
        run: |
          case "${{ inputs.action }}" in
            plan)   terraform plan -out=tfplan ;;
            apply)  terraform apply -auto-approve ;;
            destroy) terraform destroy -auto-approve ;;
          esac
        working-directory: ${{ needs.validate.outputs.env_path }}

      - name: Show Outputs
        if: inputs.action == 'apply'
        run: terraform output
        working-directory: ${{ needs.validate.outputs.env_path }}

  # ============================================
  # STAGING: Deploy to staging (requires approval)
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    needs: validate
    if: inputs.environment == 'staging'
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ needs.validate.outputs.env_path }}

      - name: Terraform ${{ inputs.action }}
        run: |
          case "${{ inputs.action }}" in
            plan)   terraform plan -out=tfplan ;;
            apply)  terraform apply -auto-approve ;;
            destroy) terraform destroy -auto-approve ;;
          esac
        working-directory: ${{ needs.validate.outputs.env_path }}

      - name: Show Outputs
        if: inputs.action == 'apply'
        run: terraform output
        working-directory: ${{ needs.validate.outputs.env_path }}

  # ============================================
  # PROD: Deploy to production (requires approval + wait)
  # ============================================
  deploy-prod:
    name: Deploy to Production
    needs: validate
    if: inputs.environment == 'prod'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ needs.validate.outputs.env_path }}

      - name: Terraform ${{ inputs.action }}
        run: |
          case "${{ inputs.action }}" in
            plan)   terraform plan -out=tfplan ;;
            apply)  terraform apply -auto-approve ;;
            destroy) terraform destroy -auto-approve ;;
          esac
        working-directory: ${{ needs.validate.outputs.env_path }}

      - name: Show Outputs
        if: inputs.action == 'apply'
        run: terraform output
        working-directory: ${{ needs.validate.outputs.env_path }}
