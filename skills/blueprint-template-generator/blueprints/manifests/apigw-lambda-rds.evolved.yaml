# Blueprint Manifest: apigw-lambda-rds (Evolved Structure)
# This is an example of the evolved manifest structure inspired by Backstage's catalog-info.yaml
# 
# Key principle: This manifest is the SINGLE SOURCE OF TRUTH for all blueprint metadata
# - MCP server reads this for discovery
# - Skills reference this for guidance
# - Catalog is generated from this
# - Templates use snippets defined here

apiVersion: blueprint.ustwo.io/v1
kind: Blueprint

metadata:
  name: apigw-lambda-rds
  title: Serverless REST API with RDS PostgreSQL
  description: Production-tested serverless API pattern with PostgreSQL database. Includes API Gateway, Lambda functions, RDS PostgreSQL, VPC configuration, and security best practices.
  
  # Categorization for discovery
  tags:
    - serverless
    - api
    - postgresql
    - sync
    - aws
  
  # Cloud provider
  cloud: aws
  
  # Origin story (for context)
  origin: "NBCU Loyalty Build (Backlot) - Web app for fan loyalty & quest rewards (ustwo, 2025)"
  
  # Version tracking
  version: 1.0.0
  lastUpdated: "2025-01-31"

spec:
  # Architecture characteristics
  database: postgresql
  pattern: sync
  apiType: rest
  
  # Components included
  components:
    - api-gateway
    - lambda
    - rds
    - vpc
    - secrets-manager
  
  # Decision tree metadata (for AI guidance)
  decision:
    when:
      - "Need serverless REST API"
      - "Need relational database"
      - "Need SQL queries"
      - "Need ACID transactions"
      - "Standard traffic patterns"
    not_when:
      - "Need GraphQL (use appsync-lambda-aurora-cognito)"
      - "Need NoSQL (use apigw-lambda-dynamodb)"
      - "Variable/unpredictable traffic (use apigw-lambda-aurora)"
      - "High-traffic production (use apigw-lambda-rds-proxy)"
  
  # Cross-cloud equivalents
  equivalents:
    azure:
      blueprint: functions-postgresql
      description: Azure Functions with PostgreSQL
    gcp:
      blueprint: appengine-cloudsql-strapi
      description: App Engine with Cloud SQL
  
  # Template generation snippets (existing structure)
  snippets:
    - id: rds-module
      name: RDS PostgreSQL Module
      description: Complete RDS module with ephemeral passwords (Flow A), IAM authentication, and VPC configuration
      template: rds-module.tf.template
      output_file: modules/data/main.tf
      category: database
      variables:
        - name: db_identifier
          type: string
          required: true
          description: RDS instance identifier (e.g., myapp-dev-db)
          pattern: "^[a-z0-9-]+$"
          example: "myapp-dev-db"
        
        - name: db_name
          type: string
          required: true
          default: "mydb"
          description: Database name
          example: "myapp"
        
        - name: engine_version
          type: string
          required: false
          default: "15.4"
          description: PostgreSQL engine version
          enum: ["15.4", "15.3", "14.9", "14.8"]
        
        - name: instance_class
          type: string
          required: false
          default: "db.t3.micro"
          description: RDS instance class
          enum: ["db.t3.micro", "db.t3.small", "db.t3.medium", "db.t3.large"]
        
        - name: allocated_storage
          type: number
          required: false
          default: 20
          description: Initial storage allocation in GB
          min: 20
          max: 65536
        
        - name: max_allocated_storage
          type: number
          required: false
          default: 100
          description: Maximum storage for autoscaling in GB
          min: 20
          max: 65536
        
        - name: db_subnet_group_name
          type: string
          required: true
          description: Existing DB subnet group name
          example: "myapp-dev-db-subnets"
        
        - name: security_group_id
          type: string
          required: true
          description: Security group ID for RDS access
          pattern: "^sg-[a-z0-9]+$"
          example: "sg-1234567890abcdef0"
        
        - name: multi_az
          type: boolean
          required: false
          default: false
          description: Enable Multi-AZ deployment for high availability
        
        - name: backup_retention_period
          type: number
          required: false
          default: 7
          description: Days to retain automated backups
          min: 0
          max: 35
        
        - name: performance_insights_enabled
          type: boolean
          required: false
          default: false
          description: Enable Performance Insights for database monitoring
        
        - name: deletion_protection
          type: boolean
          required: false
          default: false
          description: Enable deletion protection (recommended for production)
        
        - name: skip_final_snapshot
          type: boolean
          required: false
          default: true
          description: Skip final snapshot on deletion (set to false for production)
        
        - name: apply_immediately
          type: boolean
          required: false
          default: true
          description: Apply changes immediately (set to false for production maintenance windows)
      
      dependencies:
        - ephemeral-password
        - vpc-endpoints
    
    - id: ephemeral-password
      name: Ephemeral Password Pattern
      description: Flow A ephemeral password generation pattern. Password is never stored in Terraform state.
      template: ephemeral-password.tf.template
      output_file: environments/dev/ephemeral-password.tf
      category: security
      variables:
        - name: password_name
          type: string
          required: true
          default: "db"
          description: Name for the ephemeral password resource
          example: "db"
        
        - name: password_length
          type: number
          required: false
          default: 32
          description: Password length in characters
          min: 16
          max: 128
        
        - name: password_version
          type: number
          required: false
          default: 1
          description: Password version for rotation
          min: 1
      
      # No dependencies - this is a base pattern

# Links to related resources
links:
  - title: Blueprint Repository
    url: "https://github.com/berTrindade/terraform-infrastructure-blueprints/tree/main/aws/apigw-lambda-rds"
  - title: Developer Workflow
    url: "https://github.com/berTrindade/terraform-infrastructure-blueprints/blob/main/docs/developer-workflow.md"
  - title: Pattern Documentation
    url: "https://github.com/berTrindade/terraform-infrastructure-blueprints/blob/main/docs/blueprints/patterns.md"
