# .github/workflows/cleanup.yml
# Automated cleanup of orphaned test resources
# Based on terraform-skill ci-cd-workflows patterns

name: Cleanup Test Resources

on:
  schedule:
    # Run every 2 hours
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show what would be deleted)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  AWS_REGION: us-east-1

jobs:
  cleanup:
    name: Cleanup Orphaned Resources
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Find and cleanup test Lambda functions
        run: |
          DRY_RUN="${{ github.event.inputs.dry_run || 'true' }}"
          echo "Dry run: $DRY_RUN"

          # Find Lambda functions with Environment=test tag older than 2 hours
          FUNCTIONS=$(aws lambda list-functions \
            --query 'Functions[?contains(FunctionName, `test`)].FunctionName' \
            --output text)

          for FUNC in $FUNCTIONS; do
            # Check tags
            TAGS=$(aws lambda list-tags --resource $(aws lambda get-function --function-name $FUNC --query 'Configuration.FunctionArn' --output text) 2>/dev/null || echo "")

            if echo "$TAGS" | grep -q '"Environment": "test"'; then
              echo "Found test function: $FUNC"
              if [ "$DRY_RUN" = "false" ]; then
                echo "Deleting: $FUNC"
                aws lambda delete-function --function-name $FUNC || true
              else
                echo "Would delete: $FUNC (dry run)"
              fi
            fi
          done

      - name: Find and cleanup test EventBridge resources
        run: |
          DRY_RUN="${{ github.event.inputs.dry_run || 'true' }}"

          # Find EventBridge event buses with test in name
          BUSES=$(aws events list-event-buses \
            --query 'EventBuses[?contains(Name, `test`)].Name' \
            --output text 2>/dev/null || echo "")

          for BUS in $BUSES; do
            if [ "$BUS" != "default" ]; then
              echo "Found test event bus: $BUS"
              
              # First delete all rules on the bus
              RULES=$(aws events list-rules --event-bus-name "$BUS" --query 'Rules[].Name' --output text 2>/dev/null || echo "")
              for RULE in $RULES; do
                # Remove targets first
                TARGETS=$(aws events list-targets-by-rule --rule "$RULE" --event-bus-name "$BUS" --query 'Targets[].Id' --output text 2>/dev/null || echo "")
                if [ -n "$TARGETS" ]; then
                  if [ "$DRY_RUN" = "false" ]; then
                    echo "Removing targets from rule: $RULE"
                    aws events remove-targets --rule "$RULE" --event-bus-name "$BUS" --ids $TARGETS || true
                  else
                    echo "Would remove targets from rule: $RULE (dry run)"
                  fi
                fi
                
                if [ "$DRY_RUN" = "false" ]; then
                  echo "Deleting rule: $RULE"
                  aws events delete-rule --name "$RULE" --event-bus-name "$BUS" || true
                else
                  echo "Would delete rule: $RULE (dry run)"
                fi
              done
              
              if [ "$DRY_RUN" = "false" ]; then
                echo "Deleting event bus: $BUS"
                aws events delete-event-bus --name "$BUS" || true
              else
                echo "Would delete event bus: $BUS (dry run)"
              fi
            fi
          done

      - name: Find and cleanup test SQS queues
        run: |
          DRY_RUN="${{ github.event.inputs.dry_run || 'true' }}"

          # Find SQS queues with test in name
          QUEUES=$(aws sqs list-queues \
            --queue-name-prefix "test" \
            --query 'QueueUrls[]' \
            --output text 2>/dev/null || echo "")

          for QUEUE in $QUEUES; do
            TAGS=$(aws sqs list-queue-tags --queue-url "$QUEUE" 2>/dev/null || echo "")

            if echo "$TAGS" | grep -q '"Environment": "test"'; then
              echo "Found test queue: $QUEUE"
              if [ "$DRY_RUN" = "false" ]; then
                echo "Deleting: $QUEUE"
                aws sqs delete-queue --queue-url "$QUEUE" || true
              else
                echo "Would delete: $QUEUE (dry run)"
              fi
            fi
          done

      - name: Summary
        run: |
          echo "Cleanup completed."
          echo "Set dry_run to 'false' in workflow dispatch to actually delete resources."
