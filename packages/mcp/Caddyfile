{
    admin off
}

mcp.ustwo.com {
    # Handle OPTIONS preflight requests at Caddy level (before proxying)
    @options method OPTIONS
    handle @options {
        header {
            Access-Control-Allow-Origin "*"
            Access-Control-Allow-Methods "GET, POST, DELETE, OPTIONS"
            Access-Control-Allow-Headers "Authorization, Content-Type, X-Connection-ID, mcp-session-id"
            Access-Control-Max-Age "3600"
        }
        respond 204
    }
    
    # MCP HTTP endpoint (Streamable HTTP transport)
    handle /mcp {
        reverse_proxy mcp-server:3000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            transport http {
                response_header_timeout 300s
            }
        }
    }
    
    # SSE endpoint (deprecated SSE transport - for Cursor compatibility)
    handle /sse {
        reverse_proxy mcp-server:3000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            flush_interval -1
            transport http {
                response_header_timeout 300s
            }
        }
    }
    
    # Messages endpoint (for SSE transport POST requests)
    handle /messages* {
        reverse_proxy mcp-server:3000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    # OAuth endpoints
    handle /oauth/* {
        reverse_proxy mcp-server:3000
    }
    
    # OAuth metadata
    handle /.well-known/* {
        reverse_proxy mcp-server:3000
    }
    
    # Health check
    handle /health {
        reverse_proxy mcp-server:3000
    }
    
    # Default: proxy to MCP server
    handle {
        reverse_proxy mcp-server:3000
    }
    
    request_body {
        max_size 10MB
    }
    
    encode gzip {
        match {
            header Content-Type application/json*
            header Content-Type text/event-stream
        }
    }
    
    header {
        Strict-Transport-Security "max-age=63072000"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Authorization, Content-Type, X-Connection-ID, mcp-session-id"
    }
    
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }
}
