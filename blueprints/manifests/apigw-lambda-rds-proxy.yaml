# Blueprint Manifest: apigw-lambda-rds-proxy
# Serverless API with Lambda and RDS Proxy for connection pooling
name: apigw-lambda-rds-proxy
description: Serverless API with Lambda and RDS Proxy for connection pooling
version: 1.0.0

snippets:
  - id: rds-module
    name: RDS PostgreSQL Module
    description: Complete RDS module with ephemeral passwords (Flow A)
    template: rds-module.tftpl
    output_file: modules/data/main.tf
    variables:
      - name: db_identifier
        type: string
        required: true
        description: RDS instance identifier (e.g., myapp-dev-db)
        pattern: "^[a-z0-9-]+$"
      
      - name: db_name
        type: string
        required: true
        default: "mydb"
        description: Database name
      
      - name: engine_version
        type: string
        required: false
        default: "15.4"
        description: PostgreSQL engine version
      
      - name: instance_class
        type: string
        required: false
        default: "db.t3.micro"
        description: RDS instance class
        enum: ["db.t3.micro", "db.t3.small", "db.t3.medium", "db.t3.large"]
      
      - name: allocated_storage
        type: number
        required: false
        default: 20
        description: Initial storage allocation in GB
      
      - name: max_allocated_storage
        type: number
        required: false
        default: 100
        description: Maximum storage for autoscaling in GB
      
      - name: db_subnet_group_name
        type: string
        required: true
        description: Existing DB subnet group name
      
      - name: security_group_id
        type: string
        required: true
        description: Security group ID for RDS access
        pattern: "^sg-[a-z0-9]+$"
      
      - name: multi_az
        type: boolean
        required: false
        default: false
        description: Enable Multi-AZ deployment
      
      - name: backup_retention_period
        type: number
        required: false
        default: 7
        description: Days to retain backups
      
      - name: performance_insights_enabled
        type: boolean
        required: false
        default: false
        description: Enable Performance Insights
      
      - name: deletion_protection
        type: boolean
        required: false
        default: false
        description: Enable deletion protection
      
      - name: skip_final_snapshot
        type: boolean
        required: false
        default: true
        description: Skip final snapshot on deletion
      
      - name: apply_immediately
        type: boolean
        required: false
        default: true
        description: Apply changes immediately
    
    dependencies:
      - ephemeral-password

  - id: lambda-function
    name: Lambda Function
    description: Lambda function for API logic with RDS Proxy
    template: lambda-function.tftpl
    output_file: modules/api/lambda.tf
    variables:
      - name: function_name
        type: string
        required: true
        description: Lambda function name
        pattern: "^[a-z0-9-]+$"
      
      - name: runtime
        type: string
        required: false
        default: "nodejs20.x"
        description: Lambda runtime
        enum: ["nodejs18.x", "nodejs20.x", "python3.11", "python3.12"]
      
      - name: handler
        type: string
        required: true
        description: Lambda handler (e.g., index.handler)
      
      - name: timeout
        type: number
        required: false
        default: 30
        description: Lambda timeout in seconds
      
      - name: memory_size
        type: number
        required: false
        default: 256
        description: Lambda memory size in MB
        enum: [128, 256, 512, 1024, 2048, 3008]
      
      - name: environment_variables
        type: string
        required: false
        default: ""
        description: Environment variables as JSON string

  - id: ephemeral-password
    name: Ephemeral Password Pattern
    description: Flow A ephemeral password generation pattern
    template: ephemeral-password.tftpl
    output_file: environments/dev/ephemeral-password.tf
    variables:
      - name: password_name
        type: string
        required: true
        default: "db"
        description: Name for the ephemeral password resource
      
      - name: password_length
        type: number
        required: false
        default: 32
        description: Password length
      
      - name: password_version
        type: number
        required: false
        default: 1
        description: Password version for rotation
