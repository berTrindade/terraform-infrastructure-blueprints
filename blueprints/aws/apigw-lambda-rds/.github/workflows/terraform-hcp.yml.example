# .github/workflows/terraform-hcp.yml.example
# Terraform CI/CD Pipeline using HCP Terraform (Terraform Cloud)
#
# To use this workflow:
# 1. Copy this file to terraform-hcp.yml (remove .example)
# 2. Configure HCP Terraform workspaces: dev, staging, production
# 3. Set GitHub secret: TF_API_TOKEN (HCP Terraform API token)
# 4. Update TF_ORGANIZATION with your organization name
#
# This workflow uses HCP Terraform for state management and remote runs.

name: Terraform CI/CD (HCP)

on:
  pull_request:
    paths:
      - 'environments/**/*.tf'
      - 'modules/**/*.tf'
  push:
    branches:
      - main
    paths:
      - 'environments/**/*.tf'
      - 'modules/**/*.tf'

env:
  TF_VERSION: 1.11.0
  TF_ORGANIZATION: your-org-name  # Update with your HCP Terraform org

jobs:
  plan:
    name: Plan - ${{ matrix.environment }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, production]
      fail-fast: false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./environments/${{ matrix.environment }}
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
        run: |
          terraform init \
            -backend-config="organization=${{ env.TF_ORGANIZATION }}" \
            -backend-config="workspaces=name=${{ matrix.environment }}"

      - name: Terraform Format Check
        working-directory: ./environments/${{ matrix.environment }}
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        working-directory: ./environments/${{ matrix.environment }}
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./environments/${{ matrix.environment }}
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
        run: terraform plan -out=tfplan

  apply-dev:
    name: Apply - Dev
    runs-on: ubuntu-latest
    needs: plan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./environments/dev
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
        run: |
          terraform init \
            -backend-config="organization=${{ env.TF_ORGANIZATION }}" \
            -backend-config="workspaces=name=dev"

      - name: Terraform Apply
        working-directory: ./environments/dev
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
        run: terraform apply -auto-approve

  apply-staging:
    name: Apply - Staging
    runs-on: ubuntu-latest
    needs: apply-dev
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: staging
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./environments/staging
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
        run: |
          terraform init \
            -backend-config="organization=${{ env.TF_ORGANIZATION }}" \
            -backend-config="workspaces=name=staging"

      - name: Terraform Apply
        working-directory: ./environments/staging
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
        run: terraform apply -auto-approve

  apply-production:
    name: Apply - Production
    runs-on: ubuntu-latest
    needs: apply-staging
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./environments/production
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
        run: |
          terraform init \
            -backend-config="organization=${{ env.TF_ORGANIZATION }}" \
            -backend-config="workspaces=name=production"

      - name: Terraform Apply
        working-directory: ./environments/production
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
        run: terraform apply -auto-approve
